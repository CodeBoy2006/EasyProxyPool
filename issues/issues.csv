"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"CLASH-000","P0","0","backend","Finalize xray adapter architecture (strict/relaxed + observatory)","确定以 xray-core 作为协议适配层的最终架构边界：单 SOCKS 入站按 user 路由到指定 outbound，并以 (burst)Observatory+expvar 作为逐节点健康来源；明确 STRICT/RELAXED 的部署方式。","在 plan 与配置示例中明确：是否采用 2 个 xray 实例（STRICT/RELAXED 各 1 个）；明确 username=nodeID 的路由约定与 outbound tag 前缀；明确 observatory/metrics 端口与探测参数；列出不支持协议的 MVP 行为（跳过+统计）。","AUTOSERVER","Review 过程要求：不引入“一节点一端口”；严格/宽松语义必须可解释且与现有端口一致；所有日志/状态输出需脱敏（uuid/password）。","回归要求：在 100+ 节点配置下，xray 配置生成与重启可控（有上限/告警）；关闭适配层时回退到旧逻辑可正常启动。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:16;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:18;internal/orchestrator/updater.go:86;internal/health/health.go:30;docs/xray-adapter.md:1;config.yaml:1;internal/orchestrator/updater.go:86","picked_reason:document final architecture decisions for future reviews and onboarding | done_at:2025-12-23; evidence:go test ./..."
"CLASH-010","P0","2","backend","Add sources + adapters.xray config (backward compatible)","扩展 YAML 配置：引入 sources（raw_list/clash_yaml）与 adapters.xray.* 配置块，同时保持现有 proxy_list_urls 兼容。","config.Load 可解析新字段并有默认值；旧 config.yaml（仅 proxy_list_urls）仍可启动；新增字段在 README 与 config.yaml 示例中可用。","AUTOSERVER","Review 过程要求：配置字段命名清晰、默认值安全（xray 默认关闭）；校验错误信息可读且不泄露敏感信息。","回归要求：用旧配置与新配置各跑一次启动路径（至少编译/单测通过）；验证 admin/status 输出不包含密钥。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:25;internal/config/config.go:10;config.yaml:1;README.md:79;README.zh-CN.md:79","picked_reason:unblocks new config + sources for all downstream issues | done_at:2025-12-23; evidence:go test ./..."
"CLASH-020","P0","3","backend","Introduce UpstreamSpec + stable dedup + redaction","新增统一的节点/上游抽象（UpstreamSpec），提供稳定 nodeID 生成、去重规则、以及用于日志/状态的脱敏输出。","对同一节点（type+server+port+关键参数）生成稳定 nodeID；不同来源合并去重；任何日志/状态中不出现 password/uuid 等敏感字段（提供单测覆盖）。","AUTOSERVER","Review 过程要求：ID 生成可复现且不依赖顺序；脱敏函数覆盖常见字段并默认保守；避免在 error 中拼接原始节点串。","回归要求：以同一 Clash 样例重复运行，nodeID 不变；升级后仍能处理纯 ip:port 列表。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:26;internal/pool/pool.go:1;internal/orchestrator/updater.go:86;internal/upstream/spec.go:1;internal/upstream/spec_test.go:1","picked_reason:required data model for parser, xray config, and pool mapping | done_at:2025-12-23; evidence:go test ./..."
"CLASH-030","P0","4","backend","Implement Clash YAML proxies parser","实现 Clash 配置 YAML 解析：从 proxies 列表提取节点并映射为 UpstreamSpec，记录不支持协议与字段缺失错误。","给定包含 10+ 节点的 Clash YAML（覆盖 ss/vmess/vless/trojan/socks5/http），解析得到预期数量 specs；不支持协议（如 hysteria/hy2/ssr）被跳过并在统计中可见；解析错误聚合返回且不导致崩溃。","AUTOSERVER","Review 过程要求：解析逻辑对字段缺失/类型错误鲁棒；避免把原始 YAML 全量打日志；错误信息可定位到节点 name/type。","回归要求：多份变体 Clash YAML（字段顺序/额外字段）解析一致；超大文件时不 OOM（至少有限制/流式处理策略）。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:27;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:44;internal/fetcher/fetcher.go:22;internal/clash/parser.go:1;internal/clash/parser_test.go:1","picked_reason:enables clash_yaml source parsing and upstream spec generation | done_at:2025-12-23; evidence:go test ./..."
"CLASH-040","P0","5","backend","Refactor fetch pipeline to support typed sources","重构 fetcher/orchestrator：支持按 source 拉取原始内容并选择解析器，输出 UpstreamSpec 集合；保留 raw ip:port 逻辑。","sources 支持 URL/本地文件两种 clash_yaml 输入与 raw_list；输出 specs 去重；proxy_list_urls 旧路径功能不变（回归测试覆盖）。","AUTOSERVER","Review 过程要求：网络错误/解析错误分别可观测；避免把 fetcher 变成“大杂烩”，按 source 类型拆分实现。","回归要求：仅配置 proxy_list_urls 时，Strict/Relaxed 池更新行为与当前一致；并发 fetch 不引入数据竞争（go test -race 视情况）。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:28;internal/fetcher/fetcher.go:22;internal/orchestrator/updater.go:97;internal/sources/loader.go:1;internal/sources/loader_test.go:1;internal/orchestrator/updater.go:86;internal/fetcher/fetcher.go:1","picked_reason:needed to produce upstream specs from URL/file sources | done_at:2025-12-23; evidence:go test ./..."
"CLASH-050","P0","6","backend","Generate xray config: single SOCKS inbound + user routing + observatory + metrics","实现 xray 配置生成器：单 SOCKS inbound（password 认证，accounts 包含 nodeID），routing.rules 按 user 命中并转发到对应 outboundTag；启用 (burst)Observatory 与 metrics.listen（expvar /debug/vars）。","生成的配置满足：1 个 socks inbound；accounts 覆盖所有 nodeID（受 max_nodes 限制）；每个支持节点生成 1 个 outbound（tag 带 n- 前缀）；routing user→outboundTag 生效；observatory subjectSelector 匹配前缀；metrics.listen 可访问 /debug/vars（集成测试或 mock）。","AUTOSERVER","Review 过程要求：配置中不写入明文敏感信息到日志；destination/connectivity/timeout 等参数可配置且有安全默认值；不支持协议必须在生成阶段被过滤并输出统计。","回归要求：同一节点集合生成配置内容哈希稳定；节点集合变化触发幂等重启逻辑；max_nodes 超限时有清晰告警且不会生成不可用配置。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:29;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:31;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:32;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:46;internal/xray/config.go:1;internal/xray/config_test.go:1","picked_reason:required to run xray adapter and observatory-based health | done_at:2025-12-23; evidence:go test ./...; validation_limited:no xray binary executed; manual_test:provide xray binary path, enable adapters.xray, then curl http://<metrics_listen>/debug/vars; risk:medium xray config schema/version drift"
"CLASH-060","P0","6.1","backend","Implement xray process manager (start/stop/restart, strict/relaxed)","实现 xray 进程管理：按 STRICT/RELAXED 启动两个实例（独立 socks/metrics 监听），写入 work_dir 配置文件，支持配置变更重启与故障检测。","在缺少 xray 二进制时可降级运行并告警；启动后能确认 socks 与 metrics 端口已监听；配置变更触发重启（幂等，不频繁抖动）；退出时清理子进程。","AUTOSERVER","Review 过程要求：进程启动参数与工作目录权限安全；避免僵尸进程；日志分级合理且默认不输出 xray 全量配置。","回归要求：重复更新节点集合 N 次（至少 5 次）不泄露进程；SIGTERM/ctx cancel 能正确停止 xray；Docker 场景下路径可配置。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:30;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:33;internal/orchestrator/updater.go:49;cmd/easyproxypool/main.go:1;internal/xray/manager.go:1;internal/xray/manager_test.go:1","picked_reason:enables running xray adapter instances (strict/relaxed) from generated config | done_at:2025-12-23; evidence:go test ./...; validation_limited:no real xray binary executed; manual_test:set adapters.xray.binary_path to xray, enable, then start easyproxypool and verify ports listen + /debug/vars returns 200; risk:medium process args may differ by xray build"
"CLASH-070","P0","6.2","backend","Poll /debug/vars and parse observatory results into health map","实现 metrics 拉取与解析：定期 GET xray expvar `/debug/vars`，解析 observatory 字段为 per-node (alive/delay/last_error/last_try_time)；输出给 updater 用于构建池。","给定模拟 /debug/vars JSON，解析得到正确的 node health map；对缺失字段/未知 tag/格式变化可容错并告警；不会把敏感字段写日志；可配置拉取间隔/超时。","AUTOSERVER","Review 过程要求：HTTP client 超时/重试策略清晰；解析逻辑不依赖字段顺序；避免 O(N^2) 扫描导致大节点数卡顿。","回归要求：当 /debug/vars 暂时不可用时不导致 updater 崩溃（保留旧池或降级策略生效）；大量节点下解析耗时可接受（记录指标/日志）。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:32;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:35;internal/orchestrator/updater.go:86;internal/xray/metrics.go:1;internal/xray/metrics_test.go:1","picked_reason:needed to build pools from xray observatory instead of legacy TLS checker | done_at:2025-12-23; evidence:go test ./..."
"CLASH-080","P0","7","backend","Integrate updater: build pools from xray observatory (strict/relaxed)","修改 updater：使用 sources→xray→/debug/vars 的结果构建 STRICT/RELAXED 两套 pool entries，并把状态统计暴露到 admin/status。","Updater 在 xray enabled 时：strict/relaxed 池只包含 alive 节点；delay 可用于排序/统计；status 中包含：总 nodes、支持 nodes、alive nodes、跳过原因、xray 进程状态与配置哈希；xray disabled 时维持旧逻辑。","AUTOSERVER","Review 过程要求：严格保持旧功能可用；状态字段命名稳定；不要在更新失败时清空现有池（保持现有“池为空则保留旧池”的策略）。","回归要求：旧 proxy_list_urls 流程回归；xray 流程在模拟 /debug/vars 变化时能更新池；并发更新不产生数据竞争。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:35;internal/orchestrator/updater.go:86;internal/server/admin/admin.go:1;internal/orchestrator/updater.go:86;internal/orchestrator/status.go:1;internal/pool/pool.go:1;internal/server/httpproxy/proxy.go:1;internal/server/socks5proxy/server.go:1","picked_reason:core integration path to make xray+observatory nodes actually serve traffic | done_at:2025-12-23; evidence:go test ./...; validation_limited:no real xray binary executed; manual_test:configure adapters.xray.enabled=true with valid xray binary + sources.clash_yaml, run easyproxypool, verify /status shows adapter=xray and pools>0, then curl through 127.0.0.1:17283/17285; risk:medium integration drift"
"CLASH-090","P1","8","backend","Add unit tests + regression harness for new pipeline","补齐单元测试与回归：覆盖 Clash 解析、xray config 生成、/debug/vars 解析、进程 runner mock、以及旧 raw list 行为不变。","新增 *_test.go 覆盖上述模块的核心路径与错误路径；go test ./... 通过；测试不依赖外网与真实 xray 二进制（runner mock）。","AUTOSERVER","Review 过程要求：测试用例具备可读性（表驱动）；包含敏感字段脱敏断言；避免引入不稳定的时间依赖（可注入 clock）。","回归要求：跑全量单测；可选增加 race/短压测（如有资源）；确保旧配置仍能编译运行。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:36;internal/config/config.go:59;internal/fetcher/fetcher.go:22;internal/clash/parser_test.go:1;internal/xray/config_test.go:1;internal/xray/metrics_test.go:1;internal/xray/manager_test.go:1;internal/sources/loader_test.go:1","picked_reason:close remaining testing issue; most tests already exist, add legacy normalization assertions | done_at:2025-12-23; evidence:go test ./..."
"CLASH-100","P1","9","both","Update docs: config, xray dependency, security, MPL notice","更新 README/README.zh-CN 与 config.yaml 示例：说明 Clash YAML 使用方式、xray-core 安装/配置、observatory 探测参数、安全注意事项与 MPL-2.0 分发提示。","README 与 README.zh-CN 增加 Clash YAML 与 xray 配置说明；config.yaml 提供可运行示例；文档包含“无 xray 时降级行为”与排障项（metrics 端口、探测 URL）。","AUTOSERVER","Review 过程要求：文档不泄露真实节点信息；示例可直接复制使用；安全章节强调不要公网暴露端口。","回归要求：按文档步骤能启动（至少通过本地配置加载/单测）；更新点与实现一致。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:37;README.md:79;README.zh-CN.md:79;config.yaml:1;README.md:79;README.zh-CN.md:79;config.yaml:1;docs/xray-adapter.md:1","picked_reason:document how to use clash_yaml + xray adapter and operational/security guidance | done_at:2025-12-23; evidence:go test ./..."
"CLASH-110","P1","10","backend","Implement downgrade/rollback + max_nodes guardrails","实现降级/回滚：xray 不可用或 observatory/metrics 失败时不影响旧逻辑；对 max_nodes 超限、协议不支持等情况提供明确告警与统计。","xray.enabled=false 时完全不走 xray；xray.enabled=true 但 binary/metrics 异常时：不清空现有池且可选择回退到 raw socks5/http 节点；max_nodes 超限时拒绝加载并给出可定位错误；admin/status 可看到跳过原因统计。","AUTOSERVER","Review 过程要求：降级路径必须可测试；错误信息不含敏感字段；避免无限重启/抖动（退避策略）。","回归要求：故障注入（缺二进制/端口占用/metrics 404）下服务仍可运行；旧池保留策略符合预期。","已完成","已完成","已完成","已提交","","plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:38;plan/2025-12-23_21-09-39-clash-yaml-node-to-pool.md:46;internal/orchestrator/updater.go:168;internal/config/config.go:77;internal/orchestrator/updater.go:86;config.yaml:1;internal/orchestrator/status.go:1","picked_reason:ensure failures do not break legacy mode; add explicit fallback and guardrails | done_at:2025-12-23; evidence:go test ./...; validation_limited:fallback behavior needs manual run; manual_test:enable adapters.xray with invalid binary_path and set proxy_list_urls to a working list, expect adapter=xray_fallback in /status and pools populated; risk:low fallback only triggers on xray errors"
"TRACE-000","P0","11","both","Session-key Rendezvous upstream selection","将 HTTP/HTTPS(CONNECT) 的“固定出口”从 TTL 映射改为 Rendezvous Hash（HRW）：基于会话 key（优先 Proxy-Authorization username；或 `X-EasyProxyPool-Session`；可降级用 traceparent trace-id）在存活节点集合中稳定选择；节点增删/存活变化时尽量少迁移；失败时可自动尝试第二名/第三名（按 retries）且不需要维护映射表。","在 selection.sticky.enabled=true 时：对同一 session key 选择的 upstream 在存活集合不变时稳定；当节点失活/被 MarkFailure 禁用时自动切到 HRW 的下一名；支持 CONNECT 与 forward；支持 header override（可关闭 sticky / 指定 session key / 指定 failover / 强制 upstream key）；移除 TTL 映射表实现（不再需要 max_entries/ttl_seconds）；新增单测覆盖：session key 提取、HRW 选择稳定性与“排除第一名得到第二名”；go test ./... 通过。","AUTOSERVER","Review 过程要求：HRW 选择为 O(N*retries)（retries 小）且不引入新依赖；在无 session key 时保持原 round_robin/random 行为；header 不应被转发到目标站点；如 auth.username 固定导致无法复用 username 做会话，则必须支持 header 方式。","回归要求：CONNECT 与 forward 在无 session key 时维持原行为；pool 为空时返回 503；上游失败时（Do/dial 返回 error）按 retries 尝试下一名并正确 MarkFailure/MarkSuccess。","已完成","已完成","已完成","已提交","","internal/server/httpproxy/sticky.go:1;internal/server/httpproxy/proxy.go:1;internal/server/httpproxy/sticky_test.go:1;internal/pool/pool.go:1;internal/config/config.go:65;config.yaml:54;README.md:87;README.zh-CN.md:70","picked_reason:requirement change—use HRW to minimize remap when nodes change | scope_change:replace TTL sticky-map with HRW (Rendezvous) | supersedes_commit:eb5463b | done_at:2025-12-24; evidence:go test ./...; headers:X-EasyProxyPool-Session/X-EasyProxyPool-Sticky/X-EasyProxyPool-Failover/X-EasyProxyPool-Upstream"
"AUTH-000","P0","12","both","Shared-password auth mode","允许任意 Proxy-Authorization/SOCKS5 username，仅校验 password（共享密钥），以便 username 可作为会话 key/租户标识。","新增 auth.mode: shared_password；当启用时：HTTP 仅校验 Basic password==auth.password（username 任意）；SOCKS5 仅校验 password==auth.password（username 任意）；保持现有 auth 行为向后兼容（默认 basic/disabled 语义不变）；更新 README/config.yaml 并补单测覆盖 HTTP 与 SOCKS5 鉴权决策。","AUTOSERVER","Review 过程要求：shared_password 模式必须要求 auth.password 非空；所有相关 header 不得转发到目标站点；错误响应保持 407 + Proxy-Authenticate。","回归要求：basic 模式行为不变；disabled 模式行为不变；开启 shared_password 后可用不同 username 通过鉴权并参与 sticky 会话选路（可用单测/手动 curl 证明）。","已完成","已完成","已完成","已提交","","internal/server/httpproxy/proxy.go:139;internal/server/httpproxy/sticky_test.go:1;internal/server/socks5proxy/server.go:1;internal/server/socks5proxy/server_test.go:1;internal/config/config.go:55;README.md:87;README.zh-CN.md:70;config.yaml:49","picked_reason:enables per-session username while keeping a shared secret password | done_at:2025-12-24; evidence:go test ./..."
